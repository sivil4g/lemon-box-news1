<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Supabase Tables</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/test-supabase.css"></link>
    <!--–°–∫—Ä–∏–ø—Ç—ã-->
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/forum.js"></script>
    <script src="js/script.js"></script>
    <script src="js/auth-functions.js"></script>
    <script src="js/login.js"></script>
    <script src="js/register.js"></script>
<body>
    <div class="container">
        <h1><i class="fas fa-database"></i> –¢–µ—Å—Ç –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö Lemon Box</h1>
        
        <div class="test-section">
            <h3><i class="fas fa-plug"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</h3>
            <div id="connection-test" class="test-result loading">
                <i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
            </div>
        </div>
        
        <div class="test-section">
            <h3><i class="fas fa-table"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü</h3>
            <div id="tables-test" class="test-result loading">
                <i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã...
            </div>
        </div>
        
        <div class="test-section">
            <h3><i class="fas fa-users"></i> –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
            <div id="users-test" class="test-result loading">
                <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
            </div>
            <div id="users-list" class="user-list"></div>
        </div>
        
        <div class="test-section">
            <h3><i class="fas fa-comments"></i> –¢–µ—Å—Ç–æ–≤—ã–µ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞</h3>
            <div id="topics-test" class="test-result loading">
                <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—ã...
            </div>
        </div>
        
        <button class="btn" onclick="runAllTests()">
            <i class="fas fa-sync-alt"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–Ω–æ–≤–æ
        </button>
        
        <div id="stats" class="stats" style="display: none;">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div class="footer">
            <p>Project: <strong>wwygjddrxvofhwrlahpj.supabase.co</strong></p>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_URL = 'https://wwygjddrxvofhwrlahpj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3eWdqZGRyeHZvZmh3cmxhaHBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODc4NzMsImV4cCI6MjA4NTQ2Mzg3M30.fcxQSSDdlWEV6UgjRYhHFCSlaML1UaLIDpiwDqh9_Jg';
        
        // ============================================
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –ö–û–ù–§–õ–ò–ö–¢–û–í
        // ============================================
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const connectionTest = document.getElementById('connection-test');
        const tablesTest = document.getElementById('tables-test');
        const usersTest = document.getElementById('users-test');
        const topicsTest = document.getElementById('topics-test');
        const usersList = document.getElementById('users-list');
        const statsDiv = document.getElementById('stats');
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
        function getSupabaseClient() {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ window.supabaseClient (–∏–∑ supabase-config.js)
            if (window.supabaseClient) {
                console.log("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Supabase");
                return window.supabaseClient;
            }
            
            // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π
            console.log("‚ö†Ô∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π");
            const SUPABASE_URL = 'https://wwygjddrxvofhwrlahpj.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3eWdqZGRyeHZvZmh3cmxhaHBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODc4NzMsImV4cCI6MjA4NTQ2Mzg3M30.fcxQSSDdlWEV6UgjRYhHFCSlaML1UaLIDpiwDqh9_Jg';
            
            return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            connectionTest.className = 'test-result loading';
            connectionTest.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            
            const supabase = getSupabaseClient();
            
            try {
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === '42P01') {
                        // –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                        connectionTest.className = 'test-result success';
                        connectionTest.innerHTML = '<i class="fas fa-check-circle"></i> ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!';
                        return true;
                    } else {
                        throw error;
                    }
                } else {
                    connectionTest.className = 'test-result success';
                    connectionTest.innerHTML = `<i class="fas fa-check-circle"></i> ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!`;
                    return true;
                }
            } catch (error) {
                connectionTest.className = 'test-result error';
                connectionTest.innerHTML = `<i class="fas fa-times-circle"></i> ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`;
                return false;
            }
        }
        
        // –¢–µ—Å—Ç —Ç–∞–±–ª–∏—Ü
        async function testTables() {
            tablesTest.className = 'test-result loading';
            tablesTest.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã...';
            
            const supabase = getSupabaseClient();
            const tables = ['users', 'forum_topics', 'forum_posts', 'leaderboard'];
            const results = [];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('count', { count: 'exact', head: true });
                    
                    if (error && error.code === '42P01') {
                        results.push({ table, exists: false });
                    } else if (error) {
                        results.push({ table, exists: false, error: error.message });
                    } else {
                        results.push({ table, exists: true });
                    }
                } catch (error) {
                    results.push({ table, exists: false, error: error.message });
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const existingTables = results.filter(r => r.exists).length;
            const totalTables = tables.length;
            
            if (existingTables === 0) {
                tablesTest.className = 'test-result error';
                tablesTest.innerHTML = `<i class="fas fa-times-circle"></i> ‚ùå –¢–∞–±–ª–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã (0/${totalTables})`;
            } else if (existingTables < totalTables) {
                tablesTest.className = 'test-result';
                tablesTest.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ‚ö†Ô∏è –ß–∞—Å—Ç—å —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω–∞ (${existingTables}/${totalTables})`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å—Ç—å
                const details = results.map(r => 
                    `${r.table}: ${r.exists ? '‚úÖ' : '‚ùå'}`
                ).join('<br>');
                tablesTest.innerHTML += `<br><small>${details}</small>`;
            } else {
                tablesTest.className = 'test-result success';
                tablesTest.innerHTML = `<i class="fas fa-check-circle"></i> ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã (${existingTables}/${totalTables})`;
            }
            
            return results;
        }
        
        // –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function testUsers() {
            usersTest.className = 'test-result loading';
            usersTest.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...';
            usersList.innerHTML = '';
            
            const supabase = getSupabaseClient();
            
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(10);
                
                if (error) {
                    if (error.code === '42P01') {
                        usersTest.className = 'test-result error';
                        usersTest.innerHTML = '<i class="fas fa-times-circle"></i> ‚ùå –¢–∞–±–ª–∏—Ü–∞ users –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
                        return [];
                    }
                    throw error;
                }
                
                if (users.length === 0) {
                    usersTest.className = 'test-result';
                    usersTest.innerHTML = '<i class="fas fa-info-circle"></i> ‚ÑπÔ∏è –í —Ç–∞–±–ª–∏—Ü–µ users –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
                } else {
                    usersTest.className = 'test-result success';
                    usersTest.innerHTML = `<i class="fas fa-check-circle"></i> ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                    users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'user-item';
                        userDiv.innerHTML = `
                            <span class="user-name">${user.username}</span>
                            <span class="user-score">üèÜ ${user.score} (—É—Ä. ${user.level})</span>
                        `;
                        usersList.appendChild(userDiv);
                    });
                }
                
                return users;
            } catch (error) {
                usersTest.className = 'test-result error';
                usersTest.innerHTML = `<i class="fas fa-times-circle"></i> ‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                return [];
            }
        }
        
        // –¢–µ—Å—Ç —Ç–µ–º —Ñ–æ—Ä—É–º–∞
        async function testTopics() {
            topicsTest.className = 'test-result loading';
            topicsTest.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—ã...';
            
            const supabase = getSupabaseClient();
            
            try {
                const { data: topics, error } = await supabase
                    .from('forum_topics')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    if (error.code === '42P01') {
                        topicsTest.className = 'test-result error';
                        topicsTest.innerHTML = '<i class="fas fa-times-circle"></i> ‚ùå –¢–∞–±–ª–∏—Ü–∞ forum_topics –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
                        return [];
                    }
                    throw error;
                }
                
                if (topics.length === 0) {
                    topicsTest.className = 'test-result';
                    topicsTest.innerHTML = '<i class="fas fa-info-circle"></i> ‚ÑπÔ∏è –í —Ç–∞–±–ª–∏—Ü–µ forum_topics –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
                } else {
                    topicsTest.className = 'test-result success';
                    topicsTest.innerHTML = `<i class="fas fa-check-circle"></i> ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–µ–º: ${topics.length}`;
                }
                
                return topics;
            } catch (error) {
                topicsTest.className = 'test-result error';
                topicsTest.innerHTML = `<i class="fas fa-times-circle"></i> ‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                return [];
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function updateStats(users, topics) {
            statsDiv.style.display = 'grid';
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${users.length}</div>
                    <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${topics.length}</div>
                    <div class="stat-label">–¢–µ–º —Ñ–æ—Ä—É–º–∞</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${window.supabaseClient ? '‚úÖ' : '‚ùå'}</div>
                    <div class="stat-label">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">PostgreSQL</div>
                    <div class="stat-label">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            `;
        }
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
        async function runAllTests() {
            console.log('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Supabase...');
            
            // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectionOk = await testConnection();
            if (!connectionOk) {
                alert('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase! –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –∫–ª—é—á–∏ API.');
                return;
            }
            
            // –¢–µ—Å—Ç —Ç–∞–±–ª–∏—Ü
            const tablesResults = await testTables();
            
            // –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const users = await testUsers();
            
            // –¢–µ—Å—Ç —Ç–µ–º
            const topics = await testTopics();
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            await updateStats(users, topics);
            
            // –ï—Å–ª–∏ –≤—Å–µ –æ–∫ - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            if (users.length > 0 || topics.length > 0) {
                const registerBtn = document.createElement('a');
                registerBtn.href = 'register.html';
                registerBtn.className = 'btn';
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                registerBtn.style.marginTop = '20px';
                document.querySelector('.container').appendChild(registerBtn);
            }
            
            console.log('–¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
        }
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –î–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è supabase-config.js
            setTimeout(runAllTests, 500);
        });
        
        // –°–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –∫–Ω–æ–ø–∫–∏
        window.runAllTests = runAllTests;
    </script>
</body>
</html>